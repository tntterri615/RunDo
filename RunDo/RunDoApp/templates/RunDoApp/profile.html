{% extends 'RunDoApp/base.html' %}

{% block content %}

<div id="profileStats">
<h3>Your Stats:</h3>
    <div>Age: {{profile.age}}</div>
    <div>Gender: {{profile.gender}}</div>
    <div>Height: {{profile.height}} inches</div>
    <div>Weight:{{profile.weight}} lbs</div>
    <div>Fitness Level: {{fitnessLevelText}}</div>
</div>

<input type="text" id="food_api"/>
<button id="call_api" class="btn bg-dark text-white">find food</button>

<form target="" id="resultsList" method="post" style="display:none">
    <select id="food_list" ></select>
    {% csrf_token %}
    <input type="hidden" name="food_name" id="food_name">
    <input type="hidden" name="serving_calories" id="serving_calories">
    <input type="hidden" name="serving_units" id="serving_units">
    <input type="hidden" name="serving_size" id="serving_size">
    <input type="text" name="user_servings" id="user_servings" placeholder="# of servings">
    <button type="submit" class="btn btn-secondary btn-md">Calculate</button>
</form>

<script>

    document.getElementById('food_list').onchange = function(e) {
        let index = e.target.selectedIndex;
        e.target.children[index].onclick();
    };

     function http_get(url, success) {
        let xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState === 1) {
                xhttp.setRequestHeader('X-APP-ID', '{{app_id}}');
                xhttp.setRequestHeader('X-APP-KEY', '{{app_key}}')
            } else if (this.readyState === 4 && this.status === 200) {
                let data = JSON.parse(xhttp.responseText);
                success(data);
            } else if (this.readyState === 4 && this.status === 404) {
                // handle 404
            }
        };
        xhttp.open("GET", url);
        xhttp.send();
    }

    document.getElementById('call_api').onclick = function() {
        let output = document.getElementById("food_list");
        const q = document.getElementById('food_api').value;
        while(output.firstChild){
            output.removeChild(output.firstChild)
        }

        //let url = "https://trackapi.nutritionix.com/v2/search/instant/?branded=false&detailed=true&query="+q;
        let url = "https://trackapi.nutritionix.com/v2/search/instant/?self=false&branded=true&detailed=true&query="+q;
        http_get(url, function(data){
            console.log(data);
            document.getElementById('resultsList').style.display = 'block';

            let foods = [];
            for (let i=0; i<Math.min(5, data.common.length); ++i) {
                foods.push(data.common[i]);
            }
            for (let i=0; i<Math.min(5, data.branded.length); ++i) {
                foods.push(data.branded[i]);
            }

            let first_option = true;
            for (let i = 0; i < foods.length; i++){
                let food_name = document.createElement('option');
                let food = foods[i];
                let calories = 0;
                for (let i=0; i<food.full_nutrients.length; ++i) {
                    if (food.full_nutrients[i].attr_id === 208) {
                        calories = Math.round(food.full_nutrients[i].value);
                        break;
                    }
                }

                food_name.innerText = food.food_name + ", " + calories + " calories, " + food.serving_qty + " " + food.serving_unit;
                if (food.brand_name) {
                    food_name.innerText = food.brand_name + ' - ' + food_name.innerText;
                }
                food_name.onclick = function () {
                    document.getElementById('food_name').value = food.food_name;
                    document.getElementById('serving_calories').value = calories;
                    document.getElementById('serving_size').value = food.serving_qty;
                    document.getElementById('serving_units').value = food.serving_unit;
                };
                output.appendChild(food_name);

                if (first_option) {
                    first_option = false;
                    food_name.onclick();
                }
            }

        });
    };

</script>

{% endblock %}
